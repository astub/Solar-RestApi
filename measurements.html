<!DOCTYPE html>
<html>

<head>
    <title>Solar</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>
    <link rel="stylesheet" type="text/css" href="/home/style.css">
	<link rel="stylesheet" type="text/css" href="/home/skin-tx.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="pure-skin-tx">


    <p>Select Logger:
        <select name="locations" id="slct1"> </select>
    </p>


	<div class="pure-g">
   
	   <div class
	   <p>
			<br> Beginning Date (yyyy/mm/dd):
			<input type="text" id="beginDate">
			<br> Beginning Time - 24hr (hh:mm):
			<input type="text" id="beginTime">
		</p>
		
		<p>
			<br> Ending Date (yyyy/mm/dd):
			<input type="text" id="endDate">

			<br>Ending Time - 24hr (hh:mm):
			<input type="text" id="endTime">
			<br>
		</p>
	</div>
	
    <button class="pure-button pure-button-primary" value="Submit" onclick="submitUrlRequest()">Submit</button>

    <p>Select Register:
        <select name="Registers" id="reg1" onchange="showChart(this.value)"> </select>
    </p>


    <div id="Chart" style="width:100%; height:25em;"></div>


    <script>
    function reloadChart(data, yAxisName) {

        $(function() {
            $('#Chart').highcharts({
                chart: {
                    type: 'line'
                },
                title: {
                    text: (yAxisName + " Chart")
                },
                xAxis: {
                    title: {
                        text: "Time"
                    },
                    type: 'datetime',
                    dateTimeLabelFormats: { // don't display the dummy year
                        month: '%e. %b',
                        year: '%b'
                    }
                },
                yAxis: {
                    title: {
                        text: yAxisName
                    }
                },
                series: [{
                    name: 'Data',
                    data: data
                }]
            });
        });

    }
    </script>



    <script>
    function submitUrlRequest() {
        var serial = document.getElementById("slct1").value;
        var location = document.getElementById("slct1").options[document.getElementById("slct1").selectedIndex].parentNode.label;
        var beginDate = document.getElementById('beginDate').value;
        var beginTime = document.getElementById('beginTime').value;
        var endDate = document.getElementById('endDate').value;
        var endTime = document.getElementById('endTime').value;

        beginDate = beginDate.replace(/\//g, '-');
        endDate = endDate.replace(/\//g, '-');

        var urlEx = "/measurements/location/_location/serial/_serial/start/begindateTbegintime:00Z/end/enddateTendtime:00Z";

        urlEx = urlEx.replace("_location", location);
        urlEx = urlEx.replace("_serial", serial);
        urlEx = urlEx.replace("begindate", beginDate);
        urlEx = urlEx.replace("begintime", beginTime);
        urlEx = urlEx.replace("enddate", endDate);
        urlEx = urlEx.replace("endtime", endTime);

        var requestUrl = urlEx;

        //alert(requestUrl);

        sendRequest(requestUrl);

    }
    </script>




    <script>
    function populate(obj) {
        var s1 = document.getElementById("slct1");
        s1.innerHTML = "";

        for (var loc in obj) {
            var location = obj[loc].location;
            var serials = obj[loc].serials;

            var newOptGroup = document.createElement("optgroup");
            newOptGroup.label = location;
            s1.appendChild(newOptGroup);

            for (var ser in serials) {
                var serial = serials[ser];

                var newOption = document.createElement("option");
                newOption.value = serial;
                newOption.innerHTML = serial;
                newOptGroup.appendChild(newOption);
            }
        }
    }
    </script>

    <script>
    function populateRegisters(regsMap) {
        var s1 = document.getElementById("reg1");
        s1.innerHTML = "";

        for (var i in regsMap) {
            //console.log(regsMap[i]); //For testing

            var newOption = document.createElement("option");
            newOption.innerHTML = regsMap[i].name;
            newOption.value = regsMap[i].name;
            s1.appendChild(newOption);
        }


    }
    </script>


    <script>
    var regsMap;

    function load(measurements) {
        regsMap = {};
        for (var meas in measurements) {
            var time = measurements[meas].time;
            var regs = measurements[meas].registers;

            for (reg in regs) {
                if (regs[reg].name in regsMap) {
                    var regDict = regsMap[regs[reg].name];
                    var regA = regDict.regArray;
                    var regMeas = {
                        time: time,
                        data: regs[reg].data
                    };
                    regA.push(regMeas);

                } else {
                    var regA = new Array();

                    var regMeas = {
                        time: time,
                        data: regs[reg].data
                    };
                    regA.push(regMeas);

                    var regDict = {
                        name: regs[reg].name,
                        type: regs[reg].type,
                        regArray: regA
                    }

                    regsMap[regs[reg].name] = regDict
                }

            }
        }
        for (var i in regsMap) {
            console.log(regsMap[i]); //For testing
        }
        populateRegisters(regsMap);
    }

    ///TODO
    function showChart(key) {

        //console.log(key);
        var array1 = regsMap[key].regArray;
        var pointsArray = new Array();
        //alert(array1);
        array1.forEach(function(arrayItem) {
            var someDate = new Date(arrayItem.time);
            someDate = someDate.getTime();

            var x = [someDate, arrayItem.data];
            pointsArray.push(x);
        });
        yAxisName = regsMap[key].type;
        reloadChart(pointsArray, stringForType(yAxisName));
    }
    </script>


    <script>
    $(function() {
        $(function() {
            var url = '/locationsInfo';
            $.getJSON(url, function(data) {
                populate(data);
                submitUrlRequest(); //added for init async?
            });
        });
    });
    
	//INIT VIEW
    reloadChart();
    
    $today = new Date();
	$yesterday = new Date($today);
	$yesterday.setDate($today.getDate() - 1);
	
	$tomorrow = new Date($today);
	$tomorrow.setDate($today.getDate() + 1);
	
	//alert($today);
	
	$(function () {
		$('#beginDate').val($yesterday.getFullYear()+"/"+"02"+"/"+("0" + $yesterday.getDate()).slice(-2));
		$('#endDate').val($tomorrow.getFullYear()+"/"+"02"+"/"+("0" + $tomorrow.getDate()).slice(-2));
		$('#beginTime').val("09:00");
		$('#endTime').val("09:00");
		
	});
	
	
	
    </script>


    <script>
    function sendRequest(url) {
        $(function() {
            $.getJSON(url, function(data) {
                load(data);
                showChart("L1V") //FOR DEMO REMOVE OR FIX
            });
        });
    };
    </script>

    <script>

    function stringForType(type) {
    	if (type == 'I') {
    		return "Current (Amps)";

    	}
    	else if (type == 'F') {
    		return "Frequency (Hz)";
    	}
    	else if (type == 'V') {
    		return "Voltage (V)";
    	}

    }

    </script>





</body>

</html>
